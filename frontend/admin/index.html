<!DOCTYPE html>
<html lang="ru">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Admin Panel - NEON MuOnline</title>
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Montserrat:wght@400;500;700&display=swap" rel="stylesheet">
    <link rel="stylesheet" href="../css/admin.css">
</head>
<body>
    <div class="main-page">
        <div class="background-image-1" data-node-id="33:148">
            <img alt="" src="../assets/images/7f2d6aef-bc7c-47cd-946c-c72cd46f1607_1.png" />
        </div>
        <div class="background-gradient-1" data-node-id="33:149"></div>
        <div class="background-image-2-container" data-node-id="66:636">
            <div class="background-image-2-left">
                <div class="rotate-90">
                    <img alt="" src="../assets/images/87bad0a4-e952-4de0-bfd1-51d7e6df5ccc_1.png" />
                </div>
            </div>
            <div class="background-image-2-right">
                <div class="rotate-270">
                    <img alt="" src="../assets/images/87bad0a4-e952-4de0-bfd1-51d7e6df5ccc_1.png" />
                </div>
            </div>
        </div>
        <div class="background-ellipse-1" data-node-id="33:153">
            <img alt="" src="../assets/images/ellipse1.svg" />
        </div>

        <header class="admin-header">
            <div class="hero-frame">
                <div class="hero-left">
                    <h1 class="hero-title">
                        Welcome to <br />
                        NEON MuOnline!
                    </h1>
                    <p class="hero-description">
                        You've probably played Mu Online on various servers before and experienced the game in different
                        ways ‚Äî but we guarantee, you've never played a server like this.
                    </p>
                </div>

                <div class="hero-right">
                    <div class="hero-cta-block">
                        <span class="hero-cta-label">Start your adventure now:</span>
                        <a href="#" class="hero-button">
                            Read the rules
                        </a>
                    </div>

                    <!-- Language switcher -->
                    <div id="langSwitcher" class="hero-lang-switcher" style="margin-top:8px;">
                        <label for="languageSelect" class="sr-only">Language</label>
                        <select id="languageSelect" class="language-select" aria-label="Select language">
                            <option value="ru">–†—É—Å—Å–∫–∏–π (RU)</option>
                            <option value="en">English (EN)</option>
                        </select>
                    </div>

                    <div class="hero-cta-block">
                        <span class="hero-cta-label">Explore the server's features:</span>
                        <a href="#" class="hero-button">
                            Download game client
                        </a>
                    </div>
                </div>
            </div>
        </header>

        <div class="main-content-wrapper">
            <!-- Sidebar -->
            <div class="sidebar-container" data-node-id="91:912">
                <div class="sidebar-ellipse-bottom" data-node-id="91:913">
                    <img alt="" src="../assets/images/ellipse2.svg" />
                </div>
                <div class="sidebar-ellipse-top" data-node-id="91:914">
                    <img alt="" src="../assets/images/ellipse3.svg" />
                </div>
                <div class="sidebar-nav" data-node-id="91:915">
                    <!-- Dynamic sidebar nav will be injected here -->
                    <div id="sidebarNav" class="sidebar-nav-list">
                        <p class="sidebar-loading">Loading menu‚Ä¶</p>
                    </div>
                </div>
            </div>

            <div class="main-content-area">
                <!-- Search Bar -->
                <div class="search-bar" data-node-id="33:162">
                    <img alt="" src="../assets/images/material-symbols-search.svg" />
                    <p>Search</p>
                </div>

                <!-- Edit Button -->
                <div class="edit-button" data-node-id="42:102">
                    <img alt="" src="../assets/images/material-symbols-edit-outline.svg" />
                    <p>Edit</p>
                </div>

                <!-- Info Blocks -->
                <div class="info-blocks-container" data-node-id="42:303">
                    <div class="info-block-header">
                        <div class="info-block-icon">
                            <img alt="" src="../assets/images/a1f36730-fa95-49c3-910f-2d84c88b3282_1.png" />
                        </div>
                        <p class="info-block-title">General information</p>
                    </div>
                    <div class="info-tags-container">
                        <!-- Dashboard stats (populated by JS) -->
                        <div class="info-tag" data-node-id="stats:1">
                            <p>Pages: <span id="pagesCount" class="accent-text">‚Äî</span></p>
                        </div>
                        <div class="info-tag" data-node-id="stats:2">
                            <p>Blocks: <span id="blocksCount" class="accent-text">‚Äî</span></p>
                        </div>
                        <div class="info-tag" data-node-id="stats:3">
                            <p>Items: <span id="itemsCount" class="accent-text">‚Äî</span></p>
                        </div>
                        <div class="info-tag" data-node-id="42:308">
                            <p>Client: <span class="accent-text">MUs6</span></p>
                        </div>
                        <div class="info-tag" data-node-id="42:309">
                            <p><span>Classes: </span><span class="accent-text">Dark Wizard, Dark Knight, Elf, Magic Gladiator, Dark Lord, Summoner</span></p>
                        </div>
                        <div class="info-tag" data-node-id="42:310">
                            <p>Exp Rate:<span class="accent-text"> Medium</span></p>
                        </div>
                        <div class="info-tag" data-node-id="42:311">
                            <p><span>Zodiac Exp Rate: </span><span class="accent-text">Medium</span></p>
                        </div>
                        <div class="info-tag" data-node-id="42:312">
                            <p><span>Drop Rate: </span><span class="accent-text">Low</span></p>
                        </div>
                        <div class="info-tag" data-node-id="42:313">
                            <p><span>Zen Drop Rate: </span><span class="accent-text">Medium</span></p>
                        </div>
                        <div class="info-tag" data-node-id="42:314">
                            <p><span>Max Reset: </span><span class="accent-text">1000</span></p>
                        </div>
                        <div class="info-tag" data-node-id="42:315">
                            <p><span>Max points by resets 0 - 100: </span><span class="accent-text">171397</span></p>
                        </div>
                        <div class="info-tag" data-node-id="42:316">
                            <p><span>Max points by resets 101 - 1000: </span><span class="accent-text">90000</span></p>
                        </div>
                        <div class="info-tag" data-node-id="42:317">
                            <p><span>Max points from class quests: </span><span class="accent-text">9500</span></p>
                        </div>
                        <div class="info-tag" data-node-id="42:318">
                            <p><span>Max points from Noria quests: </span><span class="accent-text">33100</span></p>
                        </div>
                        <div class="info-tag" data-node-id="42:319">
                            <p><span>Max points per Zodiac levels: </span><span class="accent-text">50000</span></p>
                        </div>
                    </div>
                </div>

                <!-- Reset Details -->
                <div class="reset-details-container" data-node-id="42:320">
                    <div class="reset-details-header">
                        <p>Reset details</p>
                    </div>
                    <p class="reset-description"><span>When you reach level 400 </span><span class="accent-text">Make Reset</span><span> button will appear in your C window</span></p>
                    <div class="reset-image-container" data-node-id="42:325">
                        <img alt="" src="../assets/images/image1.png" class="reset-image" />
                    </div>
                    <p class="reset-description">OR If you have Premium you also can use Auto Reset checkbox (makes reset automatically)</p>
                    <p class="reset-description">Reset points bonus:</p>
                    <div class="reset-points-block" data-node-id="42:328">
                        <p>
                            <span>1 R - </span><span class="accent-text-purple">1000</span><span> points</span><br />
                            <span>2 R - </span><span class="accent-text-purple">990</span><span> points</span><br />
                            ...<br />
                            <span>99 R - </span><span class="accent-text-purple">20</span><span> points</span><br />
                            <span>100 R - </span><span class="accent-text-purple">10</span><span> points</span>
                        </p>
                    </div>
                    <p class="reset-info-text-block">
                        Each Zodiac level or completed quest in Quest Master increases reset limit by 1.<br />
                        Stats no burns.<br />
                        Items no burns.<br />
                        Skills no burns.<br />
                        <span>Special </span><span class="accent-text-blue">Equalizer</span><span> buff - you recieve it if your reset is lower then reset of Top player on server</span><br />
                        For each reset difference you get 5% buff. So if max reset on server is 500 you will get 2500% experience buff
                    </p>
                    <div class="reset-image-small" data-node-id="42:330">
                        <img alt="" src="../assets/images/image2.png" />
                    </div>
                    <p class="reset-info-text-block">
                        <span>Max Level: </span><span class="accent-text-blue">400</span><br />
                        <span>Points per level: </span><span class="accent-text-blue">3 </span><span>(for all classes)</span><br />
                        <span>Points per level: </span><span class="accent-text-blue">0 </span>(after reset 100)<br />
                        <span>Max Zodiac Level: </span><span class="accent-text-blue">600</span><br />
                        <span>Stamina: </span><span class="accent-text-blue">required for using Zodiac skills only</span>
                    </p>
                </div>
            </div>
        </div>

    <script src="../js/utils/api.js"></script>
    <script src="../js/utils/auth.js"></script>
    <script>
        // –ü—Ä–æ–≤–µ—Ä—è–µ–º –∞–≤—Ç–æ—Ä–∏–∑–∞—Ü–∏—é
        if (!auth.requireAuth()) {
            // –£–∂–µ –ø–µ—Ä–µ–Ω–∞–ø—Ä–∞–≤–∏–ª–∏ –Ω–∞ login
        }

        // –ü–æ–∫–∞–∑—ã–≤–∞–µ–º –∏–º—è –∞–¥–º–∏–Ω–∞
        const adminData = auth.getAdminData();
        if (adminData) {
            // document.getElementById('adminName').textContent = adminData.name || adminData.email; // –ó–∞–∫–æ–º–º–µ–Ω—Ç–∏—Ä–æ–≤–∞–Ω–æ, —Ç–∞–∫ –∫–∞–∫ —ç–ª–µ–º–µ–Ω—Ç–∞ adminName –ø–æ–∫–∞ –Ω–µ—Ç
        }

        // Language management
        const languageSelect = document.getElementById('languageSelect');

        async function loadLanguages() {
            try {
                const token = auth.getAccessToken();
                const res = await api.get('/admin/languages', token);
                if (res && res.success && Array.isArray(res.data) && res.data.length) {
                    // Populate select preserving any added options
                    const current = localStorage.getItem('neon_lang') || res.data[0].code || 'ru';
                    // Clear existing options then add from server (keep RU/EN fallback)
                    languageSelect.innerHTML = '';
                    res.data.forEach(lang => {
                        const opt = document.createElement('option');
                        opt.value = lang.code;
                        opt.textContent = lang.name_native || lang.name_en || lang.code;
                        languageSelect.appendChild(opt);
                    });
                    languageSelect.value = current;
                    setLanguage(current, false);
                } else {
                    // fallback to defaults
                    const fallback = localStorage.getItem('neon_lang') || 'ru';
                    languageSelect.value = fallback;
                    setLanguage(fallback, false);
                }
            } catch (error) {
                // fallback
                const fallback = localStorage.getItem('neon_lang') || 'ru';
                languageSelect.value = fallback;
                setLanguage(fallback, false);
            }
        }

        function setLanguage(lang, reload = true) {
            try {
                localStorage.setItem('neon_lang', lang);
            } catch (err) {}
            // update visual if needed
            if (reload) {
                loadDashboardStats();
            }
        }

        languageSelect.addEventListener('change', (e) => {
            setLanguage(e.target.value, true);
        });

        // Load initial languages
        loadLanguages();

        // –û–±—Ä–∞–±–æ—Ç–∫–∞ logout
        // document.getElementById('logoutBtn').addEventListener('click', async () => { // –ó–∞–∫–æ–º–º–µ–Ω—Ç–∏—Ä–æ–≤–∞–Ω–æ, —Ç–∞–∫ –∫–∞–∫ —ç–ª–µ–º–µ–Ω—Ç–∞ logoutBtn –ø–æ–∫–∞ –Ω–µ—Ç
        //     await auth.logout();
        //     window.location.href = '/login/index.html';
        // });

        // Dashboard stats
        async function loadDashboardStats() {
            try {
                // Pages (public)
                const pagesRes = await api.get('/pages');
                const pagesCount = pagesRes && pagesRes.count !== undefined ? pagesRes.count : (Array.isArray(pagesRes.data) ? pagesRes.data.length : '‚Äî');
                document.getElementById('pagesCount').textContent = pagesCount;

                // Blocks (admin, requires token)
                const token = auth.getAccessToken();
                let blocksCount = '‚Äî';
                try {
                    const blocksRes = await api.get('/admin/blocks', token);
                    blocksCount = blocksRes && blocksRes.count !== undefined ? blocksRes.count : (Array.isArray(blocksRes.data) ? blocksRes.data.length : '‚Äî');
                } catch (err) {
                    // leave blocksCount as '‚Äî' if unauthorized
                }
                document.getElementById('blocksCount').textContent = blocksCount;

                // Items (public, paginated)
                const itemsRes = await api.get('/items?limit=1'); // get pagination info
                const itemsTotal = itemsRes && itemsRes.pagination && itemsRes.pagination.total ? itemsRes.pagination.total : (Array.isArray(itemsRes.data) ? itemsRes.data.length : '‚Äî');
                document.getElementById('itemsCount').textContent = itemsTotal;
            } catch (error) {
                console.error('Error loading dashboard stats', error);
            }
        }

        // Initial load of stats
        loadDashboardStats();

        // Sidebar menu: load pages and render
        async function loadSidebarPages() {
            const container = document.getElementById('sidebarNav');
            if (!container) return;
            container.innerHTML = '<p class="sidebar-loading">Loading menu‚Ä¶</p>';
            try {
                const res = await api.get('/pages');
                const pages = res && res.data ? res.data : [];
                if (!Array.isArray(pages) || pages.length === 0) {
                    container.innerHTML = '<p class="sidebar-empty">No pages</p>';
                    return;
                }
                // Clear container
                container.innerHTML = '';
                pages.forEach(page => {
                    const item = document.createElement('div');
                    item.className = 'sidebar-nav-item';
                    item.dataset.pageId = page.id;

                    // Apply active class to first item for now
                    if (page.sort_order === 0 || page.display_order === 0) {
                        item.classList.add('active');
                    }

                    // Title (page.title populated by backend based on lang)
                    const p = document.createElement('p');
                    p.textContent = page.title || page.slug;
                    item.appendChild(p);

                    // Icon container (use page.icon if exists, else placeholder image)
                    const iconContainer = document.createElement('div');
                    iconContainer.className = 'icon-container';
                    const inner = document.createElement('div');
                    inner.className = 'rotate-30';
                    if (page.icon) {
                        // If icon is emoji or short string, render as text
                        if (page.icon.length <= 4 && /[^\/.]/.test(page.icon)) {
                            const span = document.createElement('span');
                            span.className = 'sidebar-icon-emoji';
                            span.textContent = page.icon;
                            inner.appendChild(span);
                        } else {
                            const img = document.createElement('img');
                            img.alt = page.title || page.slug;
                            img.src = page.icon.startsWith('/') || page.icon.startsWith('http') ? page.icon : '../assets/images/1.png';
                            inner.appendChild(img);
                        }
                    } else {
                        const img = document.createElement('img');
                        img.alt = page.title || page.slug;
                        img.src = '../assets/images/1.png';
                        inner.appendChild(img);
                    }
                    iconContainer.appendChild(inner);
                    item.appendChild(iconContainer);

                    // Click handler ‚Äî load page content into content area
                    item.addEventListener('click', async () => {
                        // mark active
                        document.querySelectorAll('.sidebar-nav .sidebar-nav-item').forEach(el => el.classList.remove('active'));
                        item.classList.add('active');
                        // Load page details (blocks) and render in content area
                        await renderPageContent(page.slug);
                    });

                    container.appendChild(item);
                });
            } catch (error) {
                console.error('Error loading sidebar pages', error);
                container.innerHTML = '<p class="sidebar-error">Failed to load menu</p>';
            }
        }

        // Render a simple pages list in content area (demo)
        async function loadPagesList() {
            const listContainerId = 'pagesListContainer';
            let listContainer = document.getElementById(listContainerId);
            if (!listContainer) {
                // Create container under main-content-area
                const mainContent = document.querySelector('.main-content-area');
                listContainer = document.createElement('div');
                listContainer.id = listContainerId;
                listContainer.className = 'pages-list-container';
                mainContent.appendChild(listContainer);
            }
            listContainer.innerHTML = '<p class="loading">Loading pages‚Ä¶</p>';
            try {
                const res = await api.get('/pages');
                const pages = res && res.data ? res.data : [];
                if (!Array.isArray(pages) || pages.length === 0) {
                    listContainer.innerHTML = '<p class="empty">No pages to display</p>';
                    return;
                }
                // Render cards
                listContainer.innerHTML = '';
                const ul = document.createElement('ul');
                ul.className = 'pages-list';
                pages.forEach(page => {
                    const li = document.createElement('li');
                    li.className = 'pages-list-item';
                    const title = page.title || page.slug;
                    li.innerHTML = `
                        <div class="page-card">
                            <div class="page-card-left">
                                <div class="page-icon">${page.icon ? page.icon : 'üìÑ'}</div>
                            </div>
                            <div class="page-card-body">
                                <div class="page-title">${escapeHtml(title)}</div>
                                <div class="page-meta">
                                    <span class="slug">${escapeHtml(page.slug)}</span>
                                    <span class="status ${page.is_active ? 'active' : 'inactive'}">${page.is_active ? 'Active' : 'Inactive'}</span>
                                </div>
                            </div>
                        </div>
                    `;
                    ul.appendChild(li);
                });
                listContainer.appendChild(ul);
            } catch (error) {
                console.error('Error loading pages list', error);
                listContainer.innerHTML = '<p class="error">Failed to load pages</p>';
            }
        }

        // Helper: load and render page content (blocks)
        async function renderPageContent(slug) {
            const mainContent = document.querySelector('.main-content-area');
            // simple loader
            const contentId = 'pageContent';
            let contentDiv = document.getElementById(contentId);
            if (!contentDiv) {
                contentDiv = document.createElement('div');
                contentDiv.id = contentId;
                contentDiv.className = 'page-content';
                mainContent.appendChild(contentDiv);
            }
            contentDiv.innerHTML = '<p class="loading">Loading page‚Ä¶</p>';
            try {
                const res = await api.get(`/pages/${encodeURIComponent(slug)}`);
                if (!res || !res.success || !res.data) {
                    contentDiv.innerHTML = '<p class="empty">Page not found</p>';
                    return;
                }
                const page = res.data;
                // Render title and blocks
                const title = page.title || page.slug;
                let html = `<h2 class="page-heading">${escapeHtml(title)}</h2>`;
                if (Array.isArray(page.blocks) && page.blocks.length) {
                    html += '<div class="blocks-list">';
                    page.blocks.forEach(b => {
                        const content = b.content || '';
                        const safeContent = escapeHtml(content);
                        html += `<div class="block-item"><div class="block-type">${escapeHtml(b.block_type_id ? String(b.block_type_id) : 'text')}</div><div class="block-content">${safeContent}</div></div>`;
                    });
                    html += '</div>';
                } else {
                    html += '<p class="no-blocks">No blocks for this page</p>';
                }
                contentDiv.innerHTML = html;
            } catch (error) {
                console.error('Error loading page content', error);
                contentDiv.innerHTML = '<p class="error">Failed to load page</p>';
            }
        }

        // Utility: escape HTML
        function escapeHtml(str) {
            if (!str) return '';
            return String(str)
                .replace(/&/g, '&amp;')
                .replace(/</g, '&lt;')
                .replace(/>/g, '&gt;')
                .replace(/"/g, '&quot;')
                .replace(/'/g, '&#039;');
        }

        // Load sidebar and pages list initially and when language changes
        loadSidebarPages();
        loadPagesList();

    </script>
</body>
</html>
